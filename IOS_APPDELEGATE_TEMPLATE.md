# iOS AppDelegate.swift Template for Push Notifications

This is a complete working template for `AppDelegate.swift` that includes the required APNs bridge methods for Capacitor push notifications.

## File Location
`ios/App/App/AppDelegate.swift`

## Complete Template

```swift
import UIKit
import Capacitor

@UIApplicationMain
class AppDelegate: UIResponder, UIApplicationDelegate {

    var window: UIWindow?

    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        // Override point for customization after application launch.
        return true
    }

    func applicationWillResignActive(_ application: UIApplication) {
        // Sent when the application is about to move from active to inactive state. This can occur for certain types of temporary interruptions (such as an incoming phone call or SMS message) or when the user quits the application and it begins the transition to the background state.
        // Use this method to pause ongoing tasks, disable timers, and invalidate graphics rendering callbacks. Games should use this method to pause the game.
    }

    func applicationDidEnterBackground(_ application: UIApplication) {
        // Use this method to release shared resources, save user data, invalidate timers, and store enough application state information to restore your application to its current state in case it is terminated later.
        // If your application supports background execution, this method is called instead of applicationWillTerminate: when the user quits.
    }

    func applicationWillEnterForeground(_ application: UIApplication) {
        // Called as part of the transition from the background to the active state; here you can undo many of the changes made on entering the background.
    }

    func applicationDidBecomeActive(_ application: UIApplication) {
        // Restart any tasks that were paused (or not yet started) while the application was inactive. If the application was previously in the background, optionally refresh the user interface.
    }

    func applicationWillTerminate(_ application: UIApplication) {
        // Called when the application is about to terminate. Save data if appropriate. See also applicationDidEnterBackground:.
    }

    func application(_ application: UIApplication, open url: URL, options: [UIApplication.OpenURLOptionsKey : Any] = [:]) -> Bool {
        // Called when the app was launched with a url. Feel free to add additional processing here,
        // but if you want the App API to support tracking app url opens, make sure to keep this call
        return ApplicationDelegateProxy.shared.application(application, open: url, options: options)
    }

    func application(_ application: UIApplication, continue userActivity: NSUserActivity, restorationHandler: @escaping ([UIUserActivityRestoring]?) -> Void) -> Bool {
        // Called when the app was launched with an activity, including Universal Links.
        // Feel free to add additional processing here, but if you want the App API to support
        // tracking app url opens, make sure to keep this call
        return ApplicationDelegateProxy.shared.application(application, continue: userActivity, restorationHandler: restorationHandler)
    }

    // MARK: - Push Notification Registration Handlers
    // ⚠️ CRITICAL: These methods are REQUIRED for Capacitor PushNotifications plugin
    // They bridge APNs token/error from native iOS to Capacitor JavaScript layer
    // Without these methods, PushNotifications.register() will timeout and fail
    
    /// Called by iOS when APNs successfully provides a device token
    /// This forwards the token to Capacitor, which then triggers the JavaScript 'registration' event
    func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        NotificationCenter.default.post(name: .capacitorDidRegisterForRemoteNotifications, object: deviceToken)
    }

    /// Called by iOS when APNs registration fails (invalid config, network issues, etc.)
    /// This forwards the error to Capacitor, which then triggers the JavaScript 'registrationError' event
    func application(_ application: UIApplication, didFailToRegisterForRemoteNotificationsWithError error: Error) {
        NotificationCenter.default.post(name: .capacitorDidFailToRegisterForRemoteNotifications, object: error)
    }

}
```

## Key Sections Explained

### Standard Capacitor Lifecycle Methods
Lines 1-46: Standard iOS app lifecycle methods generated by Capacitor. These handle app state transitions (foreground/background), URL schemes, and universal links.

### Push Notification Bridge Methods (CRITICAL)
Lines 48-61: **These two methods are the most important addition.** They were NOT generated by `npx cap add ios` and must be added manually.

#### Method 1: Success Handler
```swift
func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
    NotificationCenter.default.post(name: .capacitorDidRegisterForRemoteNotifications, object: deviceToken)
}
```

**What it does:**
- iOS calls this method when APNs successfully registers the device
- The method receives the unique device token from APNs
- It forwards the token to Capacitor using NotificationCenter
- Capacitor then triggers the JavaScript `'registration'` event
- Your JavaScript code can then save the token to the database

**Without this method:**
- `PushNotifications.register()` will wait indefinitely for a token
- The JavaScript `'registration'` listener never fires
- Registration times out after 15 seconds
- Push notifications cannot be sent to the device

#### Method 2: Error Handler
```swift
func application(_ application: UIApplication, didFailToRegisterForRemoteNotificationsWithError error: Error) {
    NotificationCenter.default.post(name: .capacitorDidFailToRegisterForRemoteNotifications, object: error)
}
```

**What it does:**
- iOS calls this method when APNs registration fails
- Common failures: invalid configuration, network issues, capabilities not enabled
- It forwards the error to Capacitor using NotificationCenter
- Capacitor then triggers the JavaScript `'registrationError'` event
- Your JavaScript code can handle the error gracefully

**Without this method:**
- Registration failures are silent in JavaScript
- You won't know why registration failed
- Debugging becomes extremely difficult

## How to Use This Template

### Option 1: Copy Entire File (Recommended for Fresh iOS Setup)
If you're starting fresh or rebuilding the iOS platform:

1. Delete the existing `ios/App/App/AppDelegate.swift`
2. Copy this entire template to `ios/App/App/AppDelegate.swift`
3. Open in Xcode: `npx cap open ios`
4. Build and run

### Option 2: Add Only the Push Methods (If AppDelegate Already Customized)
If you already have customizations in your AppDelegate:

1. Open `ios/App/App/AppDelegate.swift` in Xcode
2. Scroll to the bottom of the `AppDelegate` class (before the final `}`)
3. Add the two methods from lines 48-61 of this template
4. Add the `// MARK: - Push Notification Registration Handlers` comment for clarity
5. Save and rebuild

## Verification Checklist

After adding these methods, verify:

- [ ] Both methods are inside the `AppDelegate` class (before the final `}`)
- [ ] No syntax errors in Xcode
- [ ] Push Notifications capability enabled in Xcode → Signing & Capabilities
- [ ] Background Modes → Remote notifications enabled in Xcode
- [ ] App builds successfully in Xcode
- [ ] Registration succeeds when testing on real device
- [ ] Console shows `[Push] ✅ Token saved successfully`

## When to Use This Template

Use this template every time you:

- Run `npx cap add ios` to create the iOS platform for the first time
- Delete and rebuild the `ios/` folder
- Share the project with a new developer who needs to set up iOS
- Experience push notification registration timeouts (likely missing these methods)

## Related Documentation

- [PUSH_NOTIFICATIONS_SETUP.md](./PUSH_NOTIFICATIONS_SETUP.md) - Complete push notifications setup guide
- [CAPACITOR_SETUP.md](./CAPACITOR_SETUP.md) - General Capacitor setup (includes warning about this step)
- [IOS_SUBMISSION_GUIDE.md](./IOS_SUBMISSION_GUIDE.md) - App Store submission checklist

---

**Critical Reminder**: These two methods are the difference between working and non-working push notifications. Always add them after creating or rebuilding the iOS platform.
